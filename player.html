<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeoTV Player</title>

<script src="https://cdn.jsdelivr.net/clappr/latest/clappr.min.js"></script>
<!-- إضافة hls.js يدوياً لتحسين الأداء -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- إضافة مشغل hls.js لـ Clappr -->
<script src="https://cdn.jsdelivr.net/npm/clappr-hlsjs-plugin@latest/dist/hlsjs-plugin.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body, html {
  width: 100%;
  height: 100%;
  background: #0a0a14;
  font-family: 'Cairo', sans-serif;
  overflow: hidden;
}

.player-container {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
}

#player-wrapper {
  flex: 1;
  position: relative;
  width: 100%;
  height: calc(100% - 70px);
}

#player {
  width: 100%;
  height: 100%;
  background: #000;
}

.player-header {
  background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
  color: white;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  height: 70px;
}

.channel-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.channel-logo {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}

.channel-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.channel-details h2 {
  font-size: 1.2rem;
  margin-bottom: 3px;
  font-weight: 600;
}

.channel-details p {
  font-size: 0.85rem;
  color: rgba(255, 255, 255, 0.7);
}

.controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  padding: 8px 15px;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Cairo', sans-serif;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.3s;
}

.btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.btn i {
  font-size: 1rem;
}

.back-btn {
  background: rgba(102, 126, 234, 0.2);
  color: #667eea;
}

.back-btn:hover {
  background: rgba(102, 126, 234, 0.3);
}

.fullscreen-btn {
  background: rgba(76, 175, 80, 0.2);
  color: #4CAF50;
}

.fullscreen-btn:hover {
  background: rgba(76, 175, 80, 0.3);
}

.quality-badge {
  background: rgba(33, 150, 243, 0.2);
  color: #2196F3;
  padding: 5px 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 600;
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  color: white;
  text-align: center;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid rgba(255, 255, 255, 0.1);
  border-top: 4px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  color: white;
  text-align: center;
  padding: 20px;
}

.error-overlay i {
  font-size: 3rem;
  color: #f44336;
  margin-bottom: 20px;
}

.error-overlay h2 {
  font-size: 1.5rem;
  margin-bottom: 15px;
  color: #fff;
}

.error-overlay p {
  color: rgba(255, 255, 255, 0.8);
  margin-bottom: 5px;
  font-size: 0.9rem;
}

.error-buttons {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.error-btn {
  background: #667eea;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Cairo', sans-serif;
  font-size: 0.9rem;
  transition: all 0.3s;
}

.error-btn:hover {
  background: #5a6fd8;
  transform: translateY(-2px);
}

.error-btn.secondary {
  background: rgba(255, 255, 255, 0.1);
}

.error-btn.secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* عرض معلومات الرابط */
.stream-info {
  position: absolute;
  bottom: 60px;
  left: 10px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 0.8rem;
  z-index: 100;
  max-width: 300px;
  word-break: break-all;
  display: none;
}

.stream-info.show {
  display: block;
}

@media (max-width: 768px) {
  .player-header {
    padding: 10px 15px;
    height: 60px;
  }
  
  .channel-details h2 {
    font-size: 1rem;
  }
  
  .btn {
    padding: 6px 10px;
    font-size: 0.8rem;
  }
  
  .channel-logo {
    width: 35px;
    height: 35px;
  }
  
  .error-buttons {
    flex-direction: column;
    width: 80%;
  }
  
  .error-btn {
    width: 100%;
    margin-bottom: 10px;
  }
}
</style>
</head>

<body>

<div class="player-container">
  <div class="player-header">
    <div class="channel-info">
      <div class="channel-logo">
        <img id="channel-logo" src="" alt="Channel Logo">
      </div>
      <div class="channel-details">
        <h2 id="channel-name">جاري التحميل...</h2>
        <p id="channel-group">Leo TV Player</p>
      </div>
    </div>
    
    <div class="controls">
      <div class="quality-badge" id="quality-display">HD</div>
      <button class="btn fullscreen-btn" onclick="toggleFullscreen()">
        <i class="fas fa-expand"></i>
        <span class="fullscreen-text">ملء الشاشة</span>
      </button>
      <button class="btn back-btn" onclick="goBack()">
        <i class="fas fa-arrow-right"></i>
        <span>العودة</span>
      </button>
    </div>
  </div>
  
  <div id="player-wrapper">
    <div id="player"></div>
    <div id="stream-info" class="stream-info"></div>
    
    <div id="loading" class="loading-overlay">
      <div class="loading-spinner"></div>
      <h2>جاري تهيئة المشغل...</h2>
      <p id="loading-status">تحميل مكتبات التشغيل</p>
      <div id="technical-info" style="margin-top: 20px; font-size: 0.8rem; color: rgba(255,255,255,0.6);">
        <p>متصفحك: <span id="browser-info"></span></p>
        <p>يدعم HLS: <span id="hls-support"></span></p>
      </div>
    </div>
  </div>
</div>

<script>
// === معلومات تقنية ===
document.getElementById('browser-info').textContent = navigator.userAgent.substring(0, 50) + '...';
document.getElementById('hls-support').textContent = Hls.isSupported() ? 'نعم ✓' : 'لا ✗';

// الحصول على باراميترات URL
const urlParams = new URLSearchParams(window.location.search);
const streamUrl = decodeURIComponent(urlParams.get('url') || '');
const channelName = decodeURIComponent(urlParams.get('name') || 'قناة غير معروفة');
const channelLogo = decodeURIComponent(urlParams.get('logo') || '');
const channelGroup = decodeURIComponent(urlParams.get('group') || 'beIN Sports');
const channelQuality = decodeURIComponent(urlParams.get('quality') || 'HD');

// روابط احتياطية فعالة (مختبرة)
const backupStreams = {
  "beIN SPORT 1": [
    "https://wo.cma.footballii.ir/90live/token/Ke2TKW7sAs5LVXkl3f0j3A/1765397156/bein1_src.m3u8",
    "https://ab.footballii.ir/hls2/bein1_src.m3u8",
    "http://fuego-iptv.net/play/live.php?mac=00:1A:79:CB:46:ED&stream=1269943&extension=m3u8",
    "http://fuego-iptv.net/play/live.php?mac=00:1A:79:CB:46:ED&stream=1269943&extension=m3u8"
  ],
  "beIN SPORT 2": [
    "https://stream2.fastdelivery.net/hls/bein2/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein2/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports2/8500.m3u8"
  ],
  "beIN SPORT 3": [
    "https://stream2.fastdelivery.net/hls/bein3/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein3/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports3/8500.m3u8"
  ],
  "beIN SPORT 4": [
    "https://stream2.fastdelivery.net/hls/bein4/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein4/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports4/8500.m3u8"
  ],
  "beIN SPORT 5": [
    "https://stream2.fastdelivery.net/hls/bein5/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein5/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports5/8500.m3u8"
  ],
  "beIN SPORT 6": [
    "https://stream2.fastdelivery.net/hls/bein6/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein6/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports6/8500.m3u8"
  ],
  "beIN SPORT 7": [
    "https://stream2.fastdelivery.net/hls/bein7/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein7/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports7/8500.m3u8"
  ],
  "beIN SPORT 8": [
    "https://stream2.fastdelivery.net/hls/bein8/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein8/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports8/8500.m3u8"
  ],
  "beIN SPORT 9": [
    "https://stream2.fastdelivery.net/hls/bein9/index.m3u8",
    "https://mn-nl.mncdn.com/blutv/bein9/chunklist.m3u8",
    "https://live.kuwan8.com:9999/live/beinsports9/8500.m3u8"
  ]
};

// وظيفة لتحويل HTTP إلى HTTPS (لتجاوز مشكلة Mixed Content)
function convertToHttps(url) {
  if (url.startsWith('http://')) {
    return url.replace('http://', 'https://');
  }
  return url;
}

// وظيفة للتحقق من الرابط
function testStreamUrl(url) {
  return new Promise((resolve) => {
    fetch(url, { method: 'HEAD', mode: 'no-cors' })
      .then(() => resolve(true))
      .catch(() => {
        // تجربة HTTPS إذا كان الرابط HTTP
        if (url.startsWith('http://')) {
          const httpsUrl = convertToHttps(url);
          fetch(httpsUrl, { method: 'HEAD', mode: 'no-cors' })
            .then(() => resolve(httpsUrl))
            .catch(() => resolve(false));
        } else {
          resolve(false);
        }
      });
  });
}

let player;
let currentStreamIndex = 0;
let backupStreamsArray = [];

// تحديث المعلومات في الهيدر
document.getElementById('channel-name').textContent = channelName;
document.getElementById('channel-group').textContent = channelGroup;
document.getElementById('quality-display').textContent = channelQuality;

// تحميل صورة القناة
const logoImg = document.getElementById('channel-logo');
if (channelLogo && channelLogo.startsWith('http')) {
  logoImg.src = channelLogo;
  logoImg.onerror = function() {
    this.src = 'https://via.placeholder.com/40x40/1a1a2e/667eea?text=' + channelName.charAt(0);
  };
} else {
  logoImg.src = 'https://via.placeholder.com/40x40/1a1a2e/667eea?text=' + channelName.charAt(0);
}

// تحديث عنوان الصفحة
document.title = `${channelName} - LeoTV Player`;

async function initializePlayer() {
  // إعداد روابط احتياطية
  backupStreamsArray = [streamUrl];
  if (backupStreams[channelName]) {
    backupStreamsArray = [streamUrl, ...backupStreams[channelName]];
  }
  
  document.getElementById('loading-status').textContent = `جاري اختبار الروابط (${currentStreamIndex + 1}/${backupStreamsArray.length})...`;
  
  // اختبار الرابط الحالي
  const testResult = await testStreamUrl(backupStreamsArray[currentStreamIndex]);
  
  if (testResult === true || testResult === backupStreamsArray[currentStreamIndex]) {
    // الرابط يعمل، بدء التشغيل
    playStream(backupStreamsArray[currentStreamIndex]);
  } else if (testResult && testResult !== true && testResult !== false) {
    // تم تحويل الرابط إلى HTTPS
    playStream(testResult);
  } else {
    // الرابط لا يعمل، تجربة الرابط التالي
    if (currentStreamIndex < backupStreamsArray.length - 1) {
      currentStreamIndex++;
      initializePlayer();
    } else {
      showError('جميع الروابط غير متاحة حالياً');
    }
  }
}

function playStream(streamUrl) {
  document.getElementById('loading-status').textContent = `جاري التشغيل...`;
  document.getElementById('stream-info').textContent = `الرابط: ${streamUrl.substring(0, 80)}...`;
  document.getElementById('stream-info').classList.add('show');
  
  try {
    // تدمير المشغل القديم إذا كان موجوداً
    if (player) {
      player.destroy();
    }
    
    // إعدادات Hls.js
    const hlsConfig = {
      enableWorker: true,
      lowLatencyMode: true,
      backBufferLength: 90,
      maxBufferLength: 30,
      maxMaxBufferLength: 60,
      liveSyncDurationCount: 3,
      liveMaxLatencyDurationCount: 10,
      manifestLoadingTimeOut: 10000,
      manifestLoadingMaxRetry: 3,
      levelLoadingTimeOut: 10000,
      levelLoadingMaxRetry: 3,
      fragLoadingTimeOut: 20000,
      fragLoadingMaxRetry: 6,
      startFragPrefetch: true,
      fpsDroppedMonitoringThreshold: 0.2,
      fpsDroppedMonitoringPeriod: 5000,
      capLevelToPlayerSize: true,
      capLevelOnFPSDrop: true,
      abrEwmaDefaultEstimate: 500000,
      abrEwmaFastLive: 3,
      abrEwmaSlowLive: 9,
      abrEwmaFastVoD: 3,
      abrEwmaSlowVoD: 9,
      maxStarvationDelay: 4,
      maxLoadingDelay: 4,
      testBandwidth: true,
      progressive: false,
      lowLatencyMode: true,
      xhrSetup: function(xhr, url) {
        // إضافة headers لتجاوز CORS
        xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
        xhr.setRequestHeader('Access-Control-Allow-Credentials', 'true');
      }
    };
    
    player = new Clappr.Player({
      source: streamUrl,
      autoPlay: true,
      height: '100%',
      width: '100%',
      parentId: '#player',
      mute: false,
      volume: 80,
      playback: {
        hlsjs: hlsConfig,
        playInline: true
      },
      
      // استخدام مشغل hls.js المخصص
      plugins: [HLSJSPlayback],
      
      // ووتر مارك Leo TV
      watermark: 'https://i.imgur.com/6QyTLyj.png',
      position: 'bottom-left',
      watermarkLink: '#',
      
      // إعدادات المشغل
      mediacontrol: {
        seekbar: '#667eea',
        buttons: '#FFFFFF'
      },
      
      // إعدادات أخرى
      preload: 'auto',
      actualLiveTime: true,
      hideVolumeBar: false,
      disableKeyboardShortcuts: false,
      persistConfig: true,
      chromeless: false,
      allowUserInteraction: true,
      playbackNotSupportedMessage: 'المتصفح الحالي لا يدعم تشغيل هذا النوع من البث',
      crossOrigin: 'anonymous'
    });
    
    // إخفاء شاشة التحميل عند الاستعداد
    player.on('ready', function() {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('loading-status').textContent = 'البث يعمل الآن';
        document.getElementById('stream-info').classList.remove('show');
      }, 1000);
    });
    
    // عند بدء التشغيل
    player.on('play', function() {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('stream-info').classList.remove('show');
      }, 500);
    });
    
    // عند حدوث خطأ
    player.on('error', function(error) {
      console.error('خطأ في المشغل:', error);
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('loading-status').textContent = 'حدث خطأ، جاري المحاولة برابط آخر...';
      
      // إذا كان هناك رابط احتياطي آخر، جربه
      if (currentStreamIndex < backupStreamsArray.length - 1) {
        currentStreamIndex++;
        setTimeout(() => {
          initializePlayer();
        }, 1500);
      } else {
        showError();
      }
    });
    
    // عند انتهاء البث
    player.on('ended', function() {
      showError('انتهى البث المباشر');
    });
    
    // إظهار معلومات التحميل عند التخزين المؤقت
    player.on('buffering', function() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('loading-status').textContent = 'جاري تحميل البيانات...';
    });
    
    player.on('buffering:stop', function() {
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
      }, 500);
    });
    
  } catch (error) {
    console.error('خطأ في تهيئة المشغل:', error);
    showError();
  }
}

function showError(message) {
  document.getElementById('loading').style.display = 'none';
  
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error-overlay';
  
  const errorMessage = message || `
    <p>تعذر تشغيل القناة <strong>"${channelName}"</strong></p>
    <p style="margin: 15px 0; padding: 10px; background: rgba(255,0,0,0.1); border-radius: 8px; font-size: 0.85rem;">
      <strong>ملاحظة:</strong> معظم المتصفحات الحديثة تحظر تشغيل روابط HTTP على مواقع HTTPS<br>
      جرب أحد الحلول التالية:
    </p>
    <p style="text-align: right; font-size: 0.85rem;">
      1. استخدم متصفح Firefox (يدعم HTTP على HTTPS)<br>
      2. افتح الموقع على http بدلاً من https<br>
      3. جرب رابطاً آخر من الزر أدناه
    </p>
  `;
  
  errorDiv.innerHTML = `
    <i class="fas fa-exclamation-triangle"></i>
    <h2>عذراً!</h2>
    ${errorMessage}
    <div class="error-buttons">
      <button class="error-btn" onclick="tryNextStream()">
        <i class="fas fa-redo"></i> تجربة رابط آخر (${currentStreamIndex + 1}/${backupStreamsArray.length})
      </button>
      <button class="error-btn secondary" onclick="goBack()">
        <i class="fas fa-arrow-right"></i> العودة للقائمة
      </button>
      <button class="error-btn secondary" onclick="location.reload()">
        <i class="fas fa-sync-alt"></i> إعادة تحميل
      </button>
      <button class="error-btn secondary" onclick="openInFirefox()">
        <i class="fab fa-firefox"></i> فتح في Firefox
      </button>
    </div>
  `;
  
  // إزالة أي رسالة خطأ سابقة
  const existingError = document.querySelector('.error-overlay');
  if (existingError) {
    existingError.remove();
  }
  
  document.getElementById('player-wrapper').appendChild(errorDiv);
}

function tryNextStream() {
  if (currentStreamIndex < backupStreamsArray.length - 1) {
    currentStreamIndex++;
    document.getElementById('player-wrapper').innerHTML = `
      <div id="player"></div>
      <div id="stream-info" class="stream-info"></div>
      <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <h2>جاري تحميل البث...</h2>
        <p id="loading-status">جربة رابط احتياطي (${currentStreamIndex + 1}/${backupStreamsArray.length})</p>
      </div>
    `;
    initializePlayer();
  } else {
    showError('لا توجد روابط أخرى متاحة');
  }
}

function openInFirefox() {
  const firefoxUrl = `firefox:${window.location.href}`;
  window.open(firefoxUrl, '_blank');
}

function toggleFullscreen() {
  const elem = document.documentElement;
  
  if (!document.fullscreenElement) {
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) {
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) {
      elem.msRequestFullscreen();
    }
    
    document.querySelector('.fullscreen-text').textContent = 'تصغير';
    document.querySelector('.fullscreen-btn i').className = 'fas fa-compress';
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    
    document.querySelector('.fullscreen-text').textContent = 'ملء الشاشة';
    document.querySelector('.fullscreen-btn i').className = 'fas fa-expand';
  }
}

function goBack() {
  if (window.opener && !window.opener.closed) {
    window.close();
  } else {
    window.history.length > 1 ? window.history.back() : window.close();
  }
}

// التحكم في ملء الشاشة
document.addEventListener('fullscreenchange', updateFullscreenButton);
document.addEventListener('webkitfullscreenchange', updateFullscreenButton);

function updateFullscreenButton() {
  if (document.fullscreenElement || document.webkitFullscreenElement) {
    document.querySelector('.fullscreen-text').textContent = 'تصغير';
    document.querySelector('.fullscreen-btn i').className = 'fas fa-compress';
  } else {
    document.querySelector('.fullscreen-text').textContent = 'ملء الشاشة';
    document.querySelector('.fullscreen-btn i').className = 'fas fa-expand';
  }
}

// بدء تشغيل المشغل عند تحميل الصفحة
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    if (Hls.isSupported()) {
      initializePlayer();
    } else {
      showError('المتصفح الحالي لا يدعم تشغيل HLS. يرجى استخدام متصفح حديث مثل Chrome أو Firefox.');
    }
  }, 1000);
});

// محاولة إعادة التشغيل عند استعادة الاتصال
window.addEventListener('online', function() {
  console.log('تم استعادة الاتصال بالإنترنت');
  if (player && !player.isPlaying()) {
    setTimeout(() => {
      player.play();
    }, 1000);
  }
});

window.addEventListener('offline', function() {
  console.log('فقد الاتصال بالإنترنت');
  showError('فقد الاتصال بالإنترنت. يرجى التحقق من اتصالك وإعادة المحاولة.');
});
</script>

</body>
</html>
